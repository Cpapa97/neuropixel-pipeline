apiVersion: v1
kind: Pod
metadata:
  name: neuropixel-jupyter-gpu-test
  labels:
    app: neuropixel-jupyter-gpu-test # Reference this in your service
spec:
  restartPolicy: OnFailure
  hostNetwork: true
  volumes:
    - name: mnt
      hostPath:
        path: /mnt
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                  - at-gpu11
  priorityClassName: medium-priority #high-priority
  tolerations:
    - key: "gpu"
      operator: "Equal"
      value: "true"
      effect: "NoSchedule"
  containers:
    - name: neuropixel-jupyter-gpu-test
      image: at-docker.ad.bcm.edu:5000/kilosort4:latest
      imagePullPolicy: Always # needed because the image tag is not latest
      volumeMounts:
        - name: mnt
          mountPath: /mnt
      resources:
        requests:
          cpu: "1"
          memory: "64Gi"
        limits:
          nvidia.com/gpu: "1"
      env:
        - name: DJ_HOST
          valueFrom:
            secretKeyRef:
              name: datajoint-credentials
              key: DJ_HOST
        - name: DJ_USER
          valueFrom:
            secretKeyRef:
              name: datajoint-credentials
              key: DJ_USER
        - name: DJ_PASS
          valueFrom:
            secretKeyRef:
              name: datajoint-credentials
              key: DJ_PASS
        - name: GITHUB_USERNAME
          valueFrom:
            secretKeyRef:
              name: github-credentials
              key: GITHUB_USERNAME
        - name: GITHUB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: github-credentials
              key: GITHUB_PASSWORD
      command: ["/bin/bash"]
      args: ["-c",
        "mkdir -p /src &&\
        cd /src &&\
        git clone https://$(GITHUB_USERNAME):$(GITHUB_PASSWORD)@github.com/cajal/stimulus-pipeline.git &&\
        conda run --no-capture-output -n kilosort python -m pip install -e stimulus-pipeline/python/; \
        git clone --depth 1 --branch promote-probeinsertion https://github.com/Cpapa97/neuropixel-pipeline.git &&\
        conda run --no-capture-output -n kilosort python -m pip install -e neuropixel-pipeline/;
        cd neuropixel-pipeline/notebooks/ && conda run --no-capture-output -n kilosort \
        jupyter lab --ip=0.0.0.0 --port=9000 --allow-root --no-browser --NotebookApp.token=''"]

---
kind: Service
apiVersion: v1
metadata:
  name: neuropixel-jupyter-gpu-test-service
spec:
  type: NodePort
  selector:
    app: neuropixel-jupyter-gpu-test # reference the app label from the top
  ports:
  - protocol: TCP
    port: 9000
    targetPort: 9000
    nodePort: 32000
